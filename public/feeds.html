<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CYON SS Joachim and Anne Ijegun Web App</title>
    <link rel="stylesheet" href="css/style.css" />

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  </head>

  <body>
    <nav class="navbar">
      <div class="logo-section">
        <div class="logo">
          <img src="images/cyon-logo-png.png" alt="CYON Logo" class="logo" />
          <img src="images/ss-joachim-anne.jpeg" alt="Ss Joachim and Anne Logo" class="logo" />
        </div>

        <div class="logo-text">
          <div class="org-name">The Catholic Youth Organization of Nigeria</div>
          <div class="church-name">SS Joachim & Anne Catholic Church Ijegun</div>
        </div>

        <div class="nav-links" id="navlinks">
          <button id="showFeedsBtn" title="Feeds"><i class="fas fa-newspaper"></i></button>
          <button id="showNotificationsBtn" title="Notifications"><i class="fas fa-bell"></i></button>
          <button id="showAttendanceBtn" title="Attendance"><i class="fas fa-calendar-check"></i></button>
          <button id="showDashboardBtn" title="Admin Dashboard"><i class="fas fa-user-shield"></i></button>
          <button id="showDuesBtn" title="Pay Dues"><i class="fas fa-money-bill-wave"></i></button>
          <button id="showProfileBtn" title="Profile"><i class="fas fa-user"></i></button>
        </div>

        <button class="hamburger" id="hamburger" aria-label="Open menu">
          <i class="fas fa-bars"></i>
        </button>
      </div>
    </nav>

    <!-- Mobile dropdown menu -->
    <div class="mobile-menu" id="mobileMenu">
      <a href="#" data-section="feeds"><i class="fas fa-newspaper"></i> Feeds</a>
      <a href="#" data-section="notifications"><i class="fas fa-bell"></i> Notifications</a>
      <a href="#" data-section="attendance"><i class="fas fa-calendar-check"></i> Attendance</a>
      <!--<a href="#" data-section="dashboard"><i class="fas fa-user-shield"></i> Admin Dashboard</a> -->
      <a href="#" data-section="profile"><i class="fas fa-user"></i> My Profile</a> 
      <a href="#logout" class="logout-mobile" style="color: #ff4444; border-top: 1px solid #eee; margin-top: 10px; padding-top: 10px;">
        <i class="fas fa-sign-out-alt"></i> Logout
      </a>
    </div>

    <!-- Logout Button -->
    <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>

    <!-- Main Content Area -->
    <main id="mainContent">
      <!-- Post Form -->
      <section id="createPostSection" class="content-section active">
        <form id="postForm" enctype="multipart/form-data">
          <textarea id="postText" placeholder="What's on your mind?" rows="3"></textarea>
          <img id="preview" style="display:none; max-width:200px; margin-top:10px;" alt="Image Preview" />
          <input type="file" id="postImage" accept="image/*" />
          <button type="submit">Post</button>
        </form>
      </section>

      <!-- Feeds Container -->
      <section id="feedsSection" class="content-section active">
        <div id="feedContainer">
          <div class="loading-message">Loading feeds...</div>
        </div>
      </section>

      <!-- Other sections (initially hidden) -->
      <section id="notificationsSection" class="content-section">
        <h2>Notifications</h2>
        <div id="notificationsContainer"></div>
      </section>

      <section id="attendanceSection" class="content-section">
        <h2>Attendance</h2>
        <div id="attendanceContainer"></div>
      </section>

      <section id="dashboardSection" class="content-section">
        <h2>Admin Dashboard</h2>
        <div id="dashboardContainer"></div>
      </section>

      <section id="duesSection" class="content-section">
        <h2>Pay Dues</h2>
        <div id="duesContainer"></div>
      </section>

      <section id="profileSection" class="content-section">
        <h2>My Profile</h2>
        <div id="profileContainer"></div>
      </section>
    </main>

    <!-- ‚úÖ SAFETY CHECK: Block loading if no user data -->
    <script>
      console.log('üõ°Ô∏è SAFETY CHECK: Validating user data...');
      
      // Check for user data
      const safetyCheckCyonUser = localStorage.getItem('cyon_user_data');
      const safetyCheckLegacyUser = localStorage.getItem('user');
      
      if (!safetyCheckCyonUser && !safetyCheckLegacyUser) {
        console.error('‚ùå CRITICAL: No user data found!');
        alert('Session expired. Please log in again.');
        window.location.href = 'welcome.html';
        throw new Error('No user data - blocking page load');
      }
      
      // Parse and validate
      let validUser = null;
      if (safetyCheckCyonUser) {
        try {
          validUser = JSON.parse(safetyCheckCyonUser);
          console.log('‚úÖ Found user in cyon_user_data:', validUser.name);
        } catch (e) {
          console.error('‚ùå Failed to parse cyon_user_data');
        }
      }
      
      if (!validUser && safetyCheckLegacyUser) {
        try {
          validUser = JSON.parse(safetyCheckLegacyUser);
          console.log('‚úÖ Found user in legacy user:', validUser.name);
        } catch (e) {
          console.error('‚ùå Failed to parse legacy user');
        }
      }
      
      if (!validUser || !validUser.id || !validUser.token) {
        console.error('‚ùå CRITICAL: Invalid user data structure!');
        alert('Invalid session. Please log in again.');
        localStorage.clear();
        window.location.href = 'welcome.html';
        throw new Error('Invalid user data - blocking page load');
      }
      
      console.log('‚úÖ SAFETY CHECK PASSED');
      console.log('üë§ Validated user:', validUser.name, validUser.email, validUser.role);
      console.log('-----------------------------------');
    </script>
    
    <!-- ‚úÖ DIAGNOSTIC: Check user BEFORE any modules load -->
    <script>
      console.log('üî¨ PRE-LOAD DIAGNOSTIC STARTING...');
      console.log('üìä Checking localStorage BEFORE modules load...');
      
      // Check what's in storage RIGHT NOW
      const diagnosticCyonUser = localStorage.getItem('cyon_user_data');
      const diagnosticLegacyUser = localStorage.getItem('user');
      
      console.log('cyon_user_data exists:', !!diagnosticCyonUser);
      console.log('user exists:', !!diagnosticLegacyUser);
      
      if (diagnosticCyonUser) {
        try {
          const parsed = JSON.parse(diagnosticCyonUser);
          console.log('‚úÖ cyon_user_data:', {
            name: parsed.name,
            email: parsed.email,
            id: parsed.id,
            role: parsed.role
          });
        } catch (e) {
          console.error('‚ùå Failed to parse cyon_user_data:', e);
        }
      }
      
      if (diagnosticLegacyUser) {
        try {
          const parsed = JSON.parse(diagnosticLegacyUser);
          console.log('‚úÖ user (legacy):', {
            name: parsed.name,
            email: parsed.email,
            id: parsed.id,
            role: parsed.role
          });
        } catch (e) {
          console.error('‚ùå Failed to parse user:', e);
        }
      }
      
      console.log('üî¨ PRE-LOAD DIAGNOSTIC COMPLETE');
      console.log('-----------------------------------');
    </script>
    
    <!-- ‚úÖ FIXED: Proper script loading order -->
    
    <!-- 1. Socket.IO -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <!-- 2. Auth service (loads first, regular script) -->
    <script src="js/auth-service.js"></script>
    
    <!-- 3. Auth and page protection (regular script) -->
    <script src="js/auth.js"></script>
    
    <!-- 4. ES6 Modules (MUST have type="module") -->
    <!-- Load utils first since other modules depend on it -->
    <script type="module" src="js/utils.js"></script>
    <script type="module" src="js/app.js"></script>
    
    <!-- 5. Tagging system (regular script, must load before ui.js) -->
    <script src="js/tagging-system.js"></script>
    
    <!-- 6. UI and feeds controller (modules) -->
    <script type="module" src="js/ui.js"></script>
    <script type="module" src="js/feeds-controller.js"></script>
    
    <!-- 5. Optional: Dashboard module if it exists -->
    <!-- <script type="module" src="js/dashboard.js"></script> -->

    <script>
      // ‚úÖ CRITICAL FIX: Force fresh user data on every page load
      document.addEventListener('DOMContentLoaded', function() {
        // Check if this is a fresh login (just redirected from login page)
        const urlParams = new URLSearchParams(window.location.search);
        const fromLogin = urlParams.get('fresh') === 'true';
        
        if (fromLogin) {
          console.log('üîÑ Fresh login detected - clearing cache');
          // Clear the URL parameter
          window.history.replaceState({}, document.title, window.location.pathname);
          // Force a hard reload to clear all JavaScript cache
          window.location.reload(true);
        }
        
        // Logout Success Message Handler
        if (urlParams.get('logout') === 'success') {
          const tempMessage = document.createElement('div');
          tempMessage.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            z-index: 10000;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          `;
          tempMessage.innerHTML = '<i class="fas fa-check-circle"></i> You have been successfully logged out!';
          document.body.appendChild(tempMessage);
          
          setTimeout(() => {
            tempMessage.remove();
            window.history.replaceState({}, document.title, window.location.pathname);
          }, 3000);
        }
      });
    </script>
  </body>
</html>